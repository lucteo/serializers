<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2022-08-14" />
  <title>serializers -- Adding constraints between dynamic
computations</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
      div.csl-block{margin-left: 1.5em;}
      ul.task-list{list-style: none;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f6f8fa; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { } /* Normal */
      code span.al { color: #ff0000; } /* Alert */
      code span.an { } /* Annotation */
      code span.at { } /* Attribute */
      code span.bn { color: #9f6807; } /* BaseN */
      code span.bu { color: #9f6807; } /* BuiltIn */
      code span.cf { color: #00607c; } /* ControlFlow */
      code span.ch { color: #9f6807; } /* Char */
      code span.cn { } /* Constant */
      code span.co { color: #008000; font-style: italic; } /* Comment */
      code span.cv { color: #008000; font-style: italic; } /* CommentVar */
      code span.do { color: #008000; } /* Documentation */
      code span.dt { color: #00607c; } /* DataType */
      code span.dv { color: #9f6807; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #9f6807; } /* Float */
      code span.fu { } /* Function */
      code span.im { } /* Import */
      code span.in { color: #008000; } /* Information */
      code span.kw { color: #00607c; } /* Keyword */
      code span.op { color: #af1915; } /* Operator */
      code span.ot { } /* Other */
      code span.pp { color: #6f4e37; } /* Preprocessor */
      code span.re { } /* RegionMarker */
      code span.sc { color: #9f6807; } /* SpecialChar */
      code span.ss { color: #9f6807; } /* SpecialString */
      code span.st { color: #9f6807; } /* String */
      code span.va { } /* Variable */
      code span.vs { color: #9f6807; } /* VerbatimString */
      code span.wa { color: #008000; font-weight: bold; } /* Warning */
      code.diff {color: #898887}
      code.diff span.va {color: #006e28}
      code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
text-align: justify;
}
@media screen and (max-width: 30em) {
body {
margin: 1.5em;
}
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a {
text-decoration: none;
color: #4183C4;
}
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1, h2, h3, h4 {
position: relative;
line-height: 1;
}
a.self-link {
position: absolute;
top: 0;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
height: 2em;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
font-family: sans-serif;
font-weight: normal;
font-size: 83%;
}
a.self-link:hover { opacity: 1; }
a.self-link::before { content: "§"; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
span.marginalizedparent {
position: relative;
left: -5em;
}
li span.marginalizedparent { left: -7em; }
li ul > li span.marginalizedparent { left: -9em; }
li ul > li ul > li span.marginalizedparent { left: -11em; }
li ul > li ul > li ul > li span.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "⟵"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }

code.sourceCode > span { display: inline; }
</style>
  <link href="data:image/x-icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAVoJEAN6CRADegkQAWIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wCCRAAAgkQAAIJEAACCRAAsgkQAvoJEAP+CRAD/gkQA/4JEAP+CRADAgkQALoJEAACCRAAAgkQAAP///wD///8AgkQAAIJEABSCRACSgkQA/IJEAP99PQD/dzMA/3czAP99PQD/gkQA/4JEAPyCRACUgkQAFIJEAAD///8A////AHw+AFiBQwDqgkQA/4BBAP9/PxP/uZd6/9rJtf/bybX/upd7/39AFP+AQQD/gkQA/4FDAOqAQgBc////AP///wDKklv4jlEa/3o7AP+PWC//8+3o///////////////////////z7un/kFox/35AAP+GRwD/mVYA+v///wD///8A0Zpk+NmibP+0d0T/8evj///////+/fv/1sKz/9bCs//9/fr//////+/m2/+NRwL/nloA/5xYAPj///8A////ANKaZPjRmGH/5cKh////////////k149/3UwAP91MQD/lmQ//86rhv+USg3/m1YA/5hSAP+bVgD4////AP///wDSmmT4zpJY/+/bx///////8+TV/8mLT/+TVx//gkIA/5lVAP+VTAD/x6B//7aEVv/JpH7/s39J+P///wD///8A0ppk+M6SWP/u2sf///////Pj1f/Nj1T/2KFs/8mOUv+eWhD/lEsA/8aee/+0glT/x6F7/7J8Rvj///8A////ANKaZPjRmGH/48Cf///////+/v7/2qt//82PVP/OkFX/37KJ/86siv+USg7/mVQA/5hRAP+bVgD4////AP///wDSmmT40ppk/9CVXP/69O////////7+/v/x4M//8d/P//7+/f//////9u7n/6tnJf+XUgD/nFgA+P///wD///8A0ppk+NKaZP/RmWL/1qNy//r07///////////////////////+vXw/9akdP/Wnmn/y5FY/6JfFvj///8A////ANKaZFTSmmTo0ppk/9GYYv/Ql1//5cWm//Hg0P/x4ND/5cWm/9GXYP/RmGH/0ppk/9KaZOjVnmpY////AP///wDSmmQA0ppkEtKaZI7SmmT60ppk/9CWX//OkVb/zpFW/9CWX//SmmT/0ppk/NKaZJDSmmQS0ppkAP///wD///8A0ppkANKaZADSmmQA0ppkKtKaZLrSmmT/0ppk/9KaZP/SmmT/0ppkvNKaZCrSmmQA0ppkANKaZAD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkUtKaZNzSmmTc0ppkVNKaZADSmmQA0ppkANKaZADSmmQA////AP5/AAD4HwAA4AcAAMADAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAMADAADgBwAA+B8AAP5/AAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAyCRACMgkQA6oJEAOqCRACQgkQAEIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRABigkQA5oJEAP+CRAD/gkQA/4JEAP+CRADqgkQAZoJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAA4gkQAwoJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQAxIJEADyCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAP///wD///8A////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAWgkQAmIJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAJyCRAAYgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAdIJEAPCCRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAPSCRAB4gkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQASoJEANKCRAD/gkQA/4JEAP+CRAD/g0YA/39AAP9zLgD/bSQA/2shAP9rIQD/bSQA/3MuAP9/PwD/g0YA/4JEAP+CRAD/gkQA/4JEAP+CRADUgkQAToJEAACCRAAAgkQAAP///wD///8A////AP///wB+PwAAgkUAIoJEAKiCRAD/gkQA/4JEAP+CRAD/hEcA/4BBAP9sIwD/dTAA/5RfKv+viF7/vp56/76ee/+wiF7/lWAr/3YxAP9sIwD/f0AA/4RHAP+CRAD/gkQA/4JEAP+CRAD/gkQArIJEACaBQwAA////AP///wD///8A////AIBCAEBzNAD6f0EA/4NFAP+CRAD/gkQA/4VIAP92MwD/bSUA/6N1Tv/ezsL/////////////////////////////////38/D/6V3Uv9uJgD/dTEA/4VJAP+CRAD/gkQA/4JEAP+BQwD/fUAA/4FDAEj///8A////AP///wD///8AzJRd5qBlKf91NgD/dDUA/4JEAP+FSQD/cy4A/3YyAP/PuKP//////////////////////////////////////////////////////9K7qP94NQD/ciwA/4VJAP+CRAD/fkEA/35BAP+LSwD/mlYA6v///wD///8A////AP///wDdpnL/4qx3/8KJUv+PUhf/cTMA/3AsAP90LgD/4dK+/////////////////////////////////////////////////////////////////+TYxf91MAD/dTIA/31CAP+GRwD/llQA/6FcAP+gWwD8////AP///wD///8A////ANGZY/LSm2X/4ap3/92mcP+wdT3/byQA/8mwj////////////////////////////////////////////////////////////////////////////+LYxv9zLgP/jUoA/59bAP+hXAD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/RmWL/1p9q/9ubXv/XqXj////////////////////////////7+fD/vZyG/6BxS/+gcUr/vJuE//r37f//////////////////////3MOr/5dQBf+dVQD/nVkA/5xYAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmWP/yohJ//jo2P//////////////////////4NTG/4JDFf9lGAD/bSQA/20kAP9kGAD/fz8S/+Xb0f//////5NG9/6txN/+LOgD/m1QA/51aAP+cWAD/m1cA/5xYAP+cWADy////AP///wD///8A////ANKaZPLSmmT/0ppk/8+TWf/Unmv//v37//////////////////////+TWRr/VwsA/35AAP+ERgD/g0UA/4JGAP9lHgD/kFga/8KXX/+TRwD/jT4A/49CAP+VTQD/n10A/5xYAP+OQQD/lk4A/55cAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/y4tO/92yiP//////////////////////8NnE/8eCQP+rcTT/ez0A/3IyAP98PgD/gEMA/5FSAP+USwD/jj8A/5lUAP+JNwD/yqV2/694Mf+HNQD/jkAA/82rf/+laBj/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/LiUr/4byY///////////////////////gupX/0I5P/+Wuev/Lklz/l1sj/308AP+QSwD/ol0A/59aAP+aVQD/k0oA/8yoh///////+fXv/6pwO//Lp3v///////Pr4f+oay7y////AP///wD///8A////ANKaZPLSmmT/0ppk/8uJSv/hvJj//////////////////////+G7l//Jhkb/0ppk/96nc//fqXX/x4xO/6dkFP+QSQD/llEA/5xXAP+USgD/yaOA///////38uv/qG05/8ijdv//////8efb/6ZpLPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/zIxO/9yxh///////////////////////7dbA/8iEQf/Sm2X/0Zlj/9ScZv/eqHf/2KJv/7yAQf+XTgD/iToA/5lSAP+JNgD/yKFv/611LP+HNQD/jT8A/8qmeP+kZRT/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/Pk1n/1J5q//78+//////////////////+/fv/1aFv/8iEQv/Tm2b/0ppl/9GZY//Wn2z/1pZc/9eldf/Bl2b/kUcA/4w9AP+OQAD/lUwA/59eAP+cWQD/jT8A/5ZOAP+eXADy////AP///wD///8A////ANKaZPLSmmT/0ppk/9KZY//KiEn/8d/P///////////////////////47+f/05tm/8iCP//KiEj/yohJ/8eCP//RmGH//vfy///////n1sP/rXQ7/4k4AP+TTAD/nVoA/5xYAP+cVwD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/0ptl/8uLTf/aq37////////////////////////////+/fz/6c2y/961jv/etY7/6Myx//78+v//////////////////////3MWv/5xXD/+ORAD/mFQA/51ZAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmmT/0ppk/8mFRP/s1b//////////////////////////////////////////////////////////////////////////////+PD/0JFU/7NzMv+WUQD/kUsA/5tXAP+dWQDy////AP///wD///8A////ANKaZP/SmmT/0ppk/9KaZP/Sm2X/z5NZ/8yMT//z5NX/////////////////////////////////////////////////////////////////9Ofa/8yNUP/UmGH/36p5/8yTWv+qaSD/kksA/5ROAPz///8A////AP///wD///8A0ppk5NKaZP/SmmT/0ppk/9KaZP/TnGf/zY9T/82OUv/t1sD//////////////////////////////////////////////////////+7Yw//OkFX/zI5R/9OcZ//SmmP/26V0/9ymdf/BhUf/ol8R6P///wD///8A////AP///wDSmmQ80ppk9tKaZP/SmmT/0ppk/9KaZP/TnGj/zpFW/8qJSv/dson/8uHS//////////////////////////////////Lj0//etIv/y4lL/86QVf/TnGj/0ppk/9KaZP/RmWP/05xn/9ymdfjUnWdC////AP///wD///8A////ANKaZADSmmQc0ppkotKaZP/SmmT/0ppk/9KaZP/Tm2b/0Zli/8qJSf/NjlH/16Z3/+G8mP/myKr/5siq/+G8mP/Xp3f/zY5S/8qISf/RmGH/05tm/9KaZP/SmmT/0ppk/9KaZP/SmmSm0pljINWdaQD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkQtKaZMrSmmT/0ppk/9KaZP/SmmT/0ptl/9GYYf/Nj1P/y4lL/8qISP/KiEj/y4lK/82PU//RmGH/0ptl/9KaZP/SmmT/0ppk/9KaZP/SmmTO0ppkRtKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZGzSmmTu0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmTw0ppkcNKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZBLSmmSQ0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppklNKaZBTSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQy0ppkutKaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppkvtKaZDbSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkXNKaZODSmmT/0ppk/9KaZP/SmmT/0ppk5NKaZGDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkBtKaZIbSmmTo0ppk6tKaZIrSmmQK0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP/8P///+B///+AH//+AAf//AAD//AAAP/AAAA/gAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAfwAAAP/AAAP/8AAP//gAH//+AH///4H////D//" rel="icon" />
  
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">serializers – Adding
constraints between dynamic computations</h1>
<h3 class="subtitle" style="text-align:center">Draft Proposal</h3>
<table style="border:none;float:right">
  <tr>
    <td>Document #:</td>
    <td>D????R0</td>
  </tr>
  <tr>
    <td>Date:</td>
    <td>2022-08-14</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project:</td>
    <td>Programming Language C++</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Audience:</td>
    <td>
      SG1 Parallelism and Concurrency<br>
      LEWG Library Evolution<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to:</td>
    <td>
      Lucian Radu Teodorescu<br>&lt;<a href="mailto:lucteo@lucteo.ro" class="email">lucteo@lucteo.ro</a>&gt;<br>
    </td>
  </tr>
</table>
</header>
<div style="clear:both">
<div id="TOC" role="doc-toc">
<h1 id="toctitle">Contents</h1>
<ul>
<li><a href="#changes" id="toc-changes"><span class="toc-section-number">1</span> Changes<span></span></a>
<ul>
<li><a href="#r0" id="toc-r0"><span class="toc-section-number">1.1</span> R0<span></span></a></li>
</ul></li>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">2</span> Introduction<span></span></a></li>
<li><a href="#motivation" id="toc-motivation"><span class="toc-section-number">3</span> Motivation<span></span></a>
<ul>
<li><a href="#adding-constraints-to-dynamic-work." id="toc-adding-constraints-to-dynamic-work."><span class="toc-section-number">3.1</span> Adding constraints to dynamic
work.<span></span></a></li>
<li><a href="#moving-away-from-the-world-of-blocking-primitives" id="toc-moving-away-from-the-world-of-blocking-primitives"><span class="toc-section-number">3.2</span> Moving away from the world of
blocking primitives<span></span></a></li>
<li><a href="#mutual-exclusion-is-an-important-concept" id="toc-mutual-exclusion-is-an-important-concept"><span class="toc-section-number">3.3</span> Mutual exclusion is an important
concept<span></span></a></li>
</ul></li>
<li><a href="#usage-examples" id="toc-usage-examples"><span class="toc-section-number">4</span> Usage examples<span></span></a>
<ul>
<li><a href="#mutual-exclusion-while-accessing-a-resource" id="toc-mutual-exclusion-while-accessing-a-resource"><span class="toc-section-number">4.1</span> Mutual exclusion while accessing a
resource<span></span></a></li>
<li><a href="#limiting-the-maximum-number-of-parallel-accesses" id="toc-limiting-the-maximum-number-of-parallel-accesses"><span class="toc-section-number">4.2</span> Limiting the maximum number of
parallel accesses<span></span></a></li>
<li><a href="#readwrite-access-to-a-resource" id="toc-readwrite-access-to-a-resource"><span class="toc-section-number">4.3</span> Read/write access to a
resource<span></span></a></li>
</ul></li>
<li><a href="#synopsis" id="toc-synopsis"><span class="toc-section-number">5</span> Synopsis<span></span></a></li>
<li><a href="#design-considerations" id="toc-design-considerations"><span class="toc-section-number">6</span>
Design considerations<span></span></a>
<ul>
<li><a href="#a-new-abstraction" id="toc-a-new-abstraction"><span class="toc-section-number">6.1</span> A new
abstraction<span></span></a></li>
<li><a href="#interface-similar-to-async_scope" id="toc-interface-similar-to-async_scope"><span class="toc-section-number">6.2</span> Interface similar to
<code class="sourceCode default">async_scope</code><span></span></a></li>
<li><a href="#including-n_serializer-and-rw_serializer" id="toc-including-n_serializer-and-rw_serializer"><span class="toc-section-number">6.3</span> Including
<code class="sourceCode default">n_serializer</code> and
<code class="sourceCode default">rw_serializer</code><span></span></a></li>
<li><a href="#number-of-resources-protected-by-an-n_serializer-is-given-to-the-constructor" id="toc-number-of-resources-protected-by-an-n_serializer-is-given-to-the-constructor"><span class="toc-section-number">6.4</span> Number of resources protected by
an <code class="sourceCode default">n_serializer</code> is given to the
constructor<span></span></a></li>
<li><a href="#rw_serializer-with-two-sub-objects" id="toc-rw_serializer-with-two-sub-objects"><span class="toc-section-number">6.5</span>
<code class="sourceCode default">rw_serializer</code> with two
sub-objects<span></span></a></li>
<li><a href="#concepts-vs.-concrete-classes" id="toc-concepts-vs.-concrete-classes"><span class="toc-section-number">6.6</span> Concepts vs. concrete
classes<span></span></a></li>
<li><a href="#nest-as-a-basis-for-spawn-and-spawn_future" id="toc-nest-as-a-basis-for-spawn-and-spawn_future"><span class="toc-section-number">6.7</span>
<code class="sourceCode default">nest</code> as a basis for
<code class="sourceCode default">spawn</code> and
<code class="sourceCode default">spawn_future</code><span></span></a></li>
<li><a href="#use-of-cpos" id="toc-use-of-cpos"><span class="toc-section-number">6.8</span> Use of CPOs<span></span></a></li>
</ul></li>
<li><a href="#comparison-with-other-models" id="toc-comparison-with-other-models"><span class="toc-section-number">7</span> Comparison with other
models<span></span></a>
<ul>
<li><a href="#comparison-with-mutexes" id="toc-comparison-with-mutexes"><span class="toc-section-number">7.1</span> Comparison with
mutexes<span></span></a></li>
<li><a href="#comparison-with-p2300-model" id="toc-comparison-with-p2300-model"><span class="toc-section-number">7.2</span> Comparison with P2300
model<span></span></a></li>
<li><a href="#comparison-with-async_scope" id="toc-comparison-with-async_scope"><span class="toc-section-number">7.3</span> Comparison with
<code class="sourceCode default">async_scope</code><span></span></a></li>
<li><a href="#comparison-with-libunifexs-async_mutex" id="toc-comparison-with-libunifexs-async_mutex"><span class="toc-section-number">7.4</span> Comparison with libunifex’s
<code class="sourceCode default">async_mutex</code><span></span></a></li>
</ul></li>
<li><a href="#specification" id="toc-specification"><span class="toc-section-number">8</span> Specification<span></span></a></li>
<li><a href="#bibliography" id="toc-bibliography"><span class="toc-section-number">9</span> References<span></span></a></li>
</ul>
</div>
<h1 data-number="1" id="changes"><span class="header-section-number">1</span> Changes<a href="#changes" class="self-link"></a></h1>
<h2 data-number="1.1" id="r0"><span class="header-section-number">1.1</span> R0<a href="#r0" class="self-link"></a></h2>
<ul>
<li>first revision</li>
</ul>
<h1 data-number="2" id="introduction"><span class="header-section-number">2</span> Introduction<a href="#introduction" class="self-link"></a></h1>
<p><span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span> is a major step towards
structured concurrency. It defines building blocks that can be used to
structure concurrent programs hierarchically, ensuring safety without
any performance penalty. Senders are the right abstractions to deal with
concurrency.</p>
<p>Most of the algorithms defined in <span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span> are focused on building chains
of work. That is, to build <em>static</em> graphs of concurrent work;
the actual work that needs to be performed needs to be known
upfront.</p>
<p>In practice, though, there is also “dynamic” work. This is work that
we don’t fully know upfront. One example of “dynamic” work is the
processing of <em>N</em> chunks of data, possible with different
concurrency constraints, where <em>N</em> is a variable.</p>
<p><span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span> provides
<code class="sourceCode default">start_detached</code> and
<code class="sourceCode default">ensure_started</code> to handle with
work that doesn’t necessarily fall into “static” work category. But
these primitives are not following structured concurrency primitives,
and can be unsafe. <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span> fixes these
problems with the introduction of
<code class="sourceCode default">async_scope</code>. With this, we can
dynamically launch concurrent work safely.</p>
<p>However, these abstractions don’t allow us to establish constraints
between different work chunks. For example, if multiple parts of an
application (i.e., dynamic work) want to write data to a file, we can’t
simply add a constraint so that maximum one computation can write to the
file at any given type. As another example, we might have a limited
number of resources, let’s say <em>N</em>, so maximum <em>N</em> threads
can actively use these resources; again, there is no easy way to express
this constraint.</p>
<p>This paper aims at providing some abstractions that allow the users
to start dynamic work with constraints associated to them. It provides 3
abstractions: <code class="sourceCode default">serializer</code>,
<code class="sourceCode default">n_serializer</code> and
<code class="sourceCode default">rw_serializer</code>. These
abstractions provide similar constraints to those found in mutexes,
semaphores and read-write mutexes, but with applicability to
senders.</p>
<h1 data-number="3" id="motivation"><span class="header-section-number">3</span> Motivation<a href="#motivation" class="self-link"></a></h1>
<h2 data-number="3.1" id="adding-constraints-to-dynamic-work."><span class="header-section-number">3.1</span> Adding constraints to dynamic
work.<a href="#adding-constraints-to-dynamic-work." class="self-link"></a></h2>
<p>Virtually all threading libraries and frameworks support adding
constraints between (dynamic) work that can be executed on multiple
threads.</p>
<p>Currently, both <span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span> and <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span> lack
abstractions that allow adding constraints to dynamic work. One can use
<code class="sourceCode default">start_detached()</code> (with <span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span>) and
<code class="sourceCode default">async_scope::spawn()</code> (with <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span>), to start
dynamic work, but there is no way to add constraints between the dynamic
computations that one wants to start.</p>
<p>This paper adds abstractions that allow dynamically starting
computations with simple constraints attached to them. Even though the
constraints are simple, practice shows us that these are the most useful
constraints for most of the programs.</p>
<h2 data-number="3.2" id="moving-away-from-the-world-of-blocking-primitives"><span class="header-section-number">3.2</span> Moving away from the world of
blocking primitives<a href="#moving-away-from-the-world-of-blocking-primitives" class="self-link"></a></h2>
<p>With the new concurrency model introduced by <span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span>, people would want to move from
their legacy code-bases (with threads and locks) to this new model. To
make this transition, among others, people would have to replace
synchronization primitives with something equivalent.</p>
<p>This paper provides abstractions that integrate well with senders /
receivers framework that are equivalent to the following classic
synchronization primitives:</p>
<ul>
<li>mutexes</li>
<li>semaphores</li>
<li>read/write mutexes</li>
</ul>
<p>Using the provided primitives, the transition from threads &amp;
synchronization primitives to senders is easier.</p>
<h2 data-number="3.3" id="mutual-exclusion-is-an-important-concept"><span class="header-section-number">3.3</span> Mutual exclusion is an
important concept<a href="#mutual-exclusion-is-an-important-concept" class="self-link"></a></h2>
<p>It is said that concurrency in software has its origins in the 1965
Dijkstra’s paper <em>Solution of a problem in concurrent programming
control</em> <span class="citation" data-cites="Dijkstra65">[<a href="#ref-Dijkstra65" role="doc-biblioref">Dijkstra65</a>]</span>. The
paper provided the first solution to a concurrent problem, and the
solution was what we now call a <em>mutex</em>. A way to ensure that
multiple processes (machines in Dijkstra’s paper) have access to a
resource (<em>critical section</em>, as Dijkstra names it) in such a way
that the resource is accessed at most by one process. Mutexes are the
first solution to concurrency issues, appearing at the same time with
concurrency.</p>
<p>But, despite being the oldest solution to concurrency problems, other
solutions did not supersede it. Other synchronization primitives exist,
but one can safely say that mutex is still the most frequently used. We
can find mutexes in low-level threading frameworks, programming language
constructs, threading libraries, etc. On the other hand, the use of
semaphores (for example) is not as widespread.</p>
<p>Programs also tend to use mutexes a lot. A search on <span class="citation" data-cites="codesearch">[<a href="#ref-codesearch" role="doc-biblioref">codesearch</a>]</span> yields that almost one in
200 files contain <code class="sourceCode default">std::mutex</code>. As
a comparison, the ratio for
<code class="sourceCode default">std::thread</code> usage is 1:593, the
ratio for <code class="sourceCode default">std::atomic</code> is 1:445,
while the ratio for
<code class="sourceCode default">std:condition_variable</code> is
1:2700. The occurrence frequency of
<code class="sourceCode default">std::mutex</code> is even greater than
the occurrence frequency of
<code class="sourceCode default">std::unordered_map</code> (which is
about 1:212).</p>
<p>Moreover, in our approaches of teaching concurrency, mutexes appear
as one of the important synchronization primitives. Typically, the
teaching materials (lectures/books/articles) describe threads, and
intermediately after the problems caused by the lack of synchronization,
and then it lists mutexes as the most common solution to this
problem.</p>
<p>For better or worse, the idea of a mutually exclusive critical
section is deeply rooted in the minds of concurrent programmers. To have
the senders/receivers model be a success, we should to provide an
abstraction that is familiar to the existing programmers.</p>
<h1 data-number="4" id="usage-examples"><span class="header-section-number">4</span> Usage examples<a href="#usage-examples" class="self-link"></a></h1>
<h2 data-number="4.1" id="mutual-exclusion-while-accessing-a-resource"><span class="header-section-number">4.1</span> Mutual exclusion while
accessing a resource<a href="#mutual-exclusion-while-accessing-a-resource" class="self-link"></a></h2>
<p>Let’s assume that we are building a game. In this game, we need to
save the state of the game at certain points, based on multiple
triggers. The triggers are independent of each-other, and we can imagine
multiple triggers will activate at the same time.</p>
<p>The functionality that saves the state of the game doesn’t make sense
to be called in parallel by multiple threads. Thus, after one trigger
starts the saving of the state, other triggers cannot start another save
process. The process for saving the state corresponding to the second
trigger must start only after the first saving of the state process
completes.</p>
<p>In the classical concurrency model with threads and locks, we would
add a mutex around the process of saving the game state. This is the
classic example of using a mutex.</p>
<p>With this paper, one can use senders and achieve mutual
exclusion:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">::</span>execution;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>serializer save_ser;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>system_context ctx;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">// can be called in parallel from multiple threads</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// exits immediately</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> trigger_save<span class="op">(</span>game_state state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> do_save <span class="op">=</span> <span class="op">[</span>state<span class="op">]</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// this is going to be serialized; at most one thread in this scope, at a given time</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    game_save_process saver <span class="op">=</span> <span class="op">...</span>;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    saver<span class="op">.</span>save<span class="op">(</span>state<span class="op">)</span>;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  scheduler <span class="kw">auto</span> sch <span class="op">=</span> ctx<span class="op">.</span>scheduler<span class="op">()</span>;</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  save_ser<span class="op">.</span>spawn<span class="op">(</span>on<span class="op">(</span>sch, just<span class="op">()</span> <span class="op">|</span> then<span class="op">(</span>do_save<span class="op">)))</span>;</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="4.2" id="limiting-the-maximum-number-of-parallel-accesses"><span class="header-section-number">4.2</span> Limiting the maximum number of
parallel accesses<a href="#limiting-the-maximum-number-of-parallel-accesses" class="self-link"></a></h2>
<p>Let’s assume that we have an application that tries to download
multiple files on an embedded device with limited bandwidth. Although we
can download multiple files in parallel, but because of the limited
bandwidth, it may not be worth to download too many files at the same
time. In addition to that, let’s assume that creating a connection is a
complex process, and we want to limit the number of connections we
created.</p>
<p>Thus, we have a problem in which we have a limited number of
connections we can use. In the classic concurrent model, one can use a
counting semaphore to limit the number of connections that can be used
at a given time. With this paper, one can use an
<code class="sourceCode default">n_serializer</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">::</span>execution;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">int</span> num_parallel_conns <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>vector<span class="op">&lt;</span>connection_t<span class="op">&gt;</span> connections <span class="op">=</span> <span class="op">...</span>;           <span class="co">// assume we have 5 connections</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> conn_handle_t <span class="op">=</span> <span class="op">...</span>; <span class="co">// handle to a connection_t from the vector; dtor will mark the connection as free</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>n_serializer connections_ser<span class="op">{</span>num_parallel_conns<span class="op">}</span>;</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>system_context ctx;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> download<span class="op">(</span>url_t url<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> protected_work <span class="op">=</span> <span class="op">[</span>url<span class="op">]</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// At most `num_parallel_conns` threads will enter this region</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get a free connection (guaranteed to have one)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    conn_handle_t conn <span class="op">=</span> acquire_free_connection<span class="op">(</span>connections<span class="op">)</span>;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start downloading on that connection</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> just<span class="op">(</span>conn<span class="op">)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>         <span class="op">|</span> let_value<span class="op">([</span>url<span class="op">](</span>conn_handle_t conn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> conn<span class="op">.</span>download<span class="op">(</span>url<span class="op">)</span>;</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>         <span class="op">})</span>;</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// When the handle is destroyed, the connection will go back in the pool as a free connection</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Spawn the work and return a sender that is triggered when the download completes</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  scheduler <span class="kw">auto</span> sch <span class="op">=</span> ctx<span class="op">.</span>scheduler<span class="op">()</span>;</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> connections_ser<span class="op">.</span>spawn_future<span class="op">(</span>on<span class="op">(</span>sch, just<span class="op">()</span> <span class="op">|</span> then<span class="op">(</span>protected_work<span class="op">)))</span>;</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="4.3" id="readwrite-access-to-a-resource"><span class="header-section-number">4.3</span> Read/write access to a
resource<a href="#readwrite-access-to-a-resource" class="self-link"></a></h2>
<p>Let’s assume we have a game for which we load data dynamically as the
player explore the game world. Once the game data is loaded, it is
immutable. We might have multiple parts of the game reading the game
data at the same time without any safety issue, but we cannot write the
game data in parallel with any reads (or other writes).</p>
<p>In the classic concurrency model, this would be solved with a
read-write mutex (shared mutex). With this paper, we can use
<code class="sourceCode default">rw_serializer</code> to apply the same
idea to senders.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">::</span>execution;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> game_data_t;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> load_data_for_area<span class="op">(</span>area_id id, game_data_t<span class="op">&amp;</span> game_data<span class="op">)</span>;</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> unprotected_render<span class="op">(</span><span class="kw">const</span> game_data_t<span class="op">&amp;</span> game_data<span class="op">)</span>;</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>game_data_t game_data;</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>rw_serializer game_data_ser;</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>system_context ctx;</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> start_load_area<span class="op">(</span>area_id id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> protected_work <span class="op">=</span> <span class="op">[</span>id<span class="op">]</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// exclusive access to game_data while in this scope</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    load_data_for_area<span class="op">(</span>id, game_data<span class="op">)</span>;</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  scheduler <span class="kw">auto</span> sch <span class="op">=</span> ctx<span class="op">.</span>scheduler<span class="op">()</span>;</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  game_data_ser<span class="op">.</span>get_writer<span class="op">().</span>spawn<span class="op">(</span>on<span class="op">(</span>sch, just<span class="op">()</span> <span class="op">|</span> then<span class="op">(</span>protected_work<span class="op">)))</span>;</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> render<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> protected_work <span class="op">=</span> <span class="op">[]</span> <span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// data doesn&#39;t change while rendering the scene</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    unprotected_render<span class="op">(</span>game_data<span class="op">)</span>;</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  scheduler <span class="kw">auto</span> sch <span class="op">=</span> ctx<span class="op">.</span>scheduler<span class="op">()</span>;</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> game_data_ser<span class="op">.</span>get_reader<span class="op">().</span>spawn_future<span class="op">(</span>on<span class="op">(</span>sch, just<span class="op">()</span> <span class="op">|</span> then<span class="op">(</span>protected_work<span class="op">)))</span>;</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> spawn_enemies<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// similar to render()</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 data-number="5" id="synopsis"><span class="header-section-number">5</span> Synopsis<a href="#synopsis" class="self-link"></a></h1>
<p>Depending on the outcome of <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span>, the 3
proposed abstractions might look like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Similar to async_scope, but with the following constraint:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">//      maximum one given sender can be executed in parallel</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Same idea as with mutexes, but using senders.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> serializer <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">()</span>;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>serializer<span class="op">()</span>;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">(</span><span class="kw">const</span> serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">(</span>serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="kw">const</span> serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> spawn<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <em>spawn-future-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> spawn_future<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <em>nest-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> nest<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <em>on-empty-sender</em> on_empty<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    in_place_stop_source<span class="op">&amp;</span> get_stop_source<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    in_place_stop_token get_stop_token<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> request_stop<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Similar to async_scope/serializer, but with the following constraint:</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">//      maximum N senders can be executed in parallel, where N is given to ctor</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Same idea as with semaphores, but using senders.</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> n_serializer <span class="op">{</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">explicit</span> n_serializer<span class="op">(</span><span class="dt">int</span> max_parallel<span class="op">)</span>;</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>n_serializer<span class="op">()</span>;</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    n_serializer<span class="op">(</span><span class="kw">const</span> n_serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    n_serializer<span class="op">(</span>n_serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    n_serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="kw">const</span> n_serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    n_serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>n_serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> spawn<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <em>spawn-future-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> spawn_future<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <em>nest-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> nest<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <em>on-empty-sender</em> on_empty<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    in_place_stop_source<span class="op">&amp;</span> get_stop_source<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    in_place_stop_token get_stop_token<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> request_stop<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Similar to async_scope/serializer, but with the following constraints:</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">//      - there are two types of senders: READ and WRITE</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co">//      - a WRITE sender cannot be executed in parallel with other WRITE or READ senders</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co">//      - multiple READ senders can be executed in parallel.</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Same idea as with read-write mutexes, but using senders.</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> rw_serializer <span class="op">{</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    rw_serializer<span class="op">()</span>;</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>rw_serializer<span class="op">()</span>;</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    rw_serializer<span class="op">(</span><span class="kw">const</span> rw_serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    rw_serializer<span class="op">(</span>rw_serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    rw_serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="kw">const</span> rw_serializer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    rw_serializer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>rw_serializer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> reader <span class="op">{</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">~</span>reader<span class="op">()</span>;</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        reader<span class="op">(</span><span class="kw">const</span> reader<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        reader<span class="op">(</span>reader<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        reader<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="kw">const</span> reader<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        reader<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>reader<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> spawn<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <em>spawn-future-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> spawn_future<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <em>nest-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> nest<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span><span class="op">:</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        reader<span class="op">(</span>rw_serializer<span class="op">*</span> parent<span class="op">)</span>;</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> writer <span class="op">{</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">~</span>writer<span class="op">()</span>;</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">(</span><span class="kw">const</span> writer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">(</span>writer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="kw">const</span> writer<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>writer<span class="op">&amp;&amp;)</span> <span class="op">=</span> <span class="kw">delete</span>;</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> spawn<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <em>spawn-future-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> spawn_future<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        <span class="kw">template</span> <span class="op">&lt;</span>sender S<span class="op">&gt;</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        <em>nest-sender</em><span class="op">&lt;</span>S<span class="op">&gt;</span> nest<span class="op">(</span>S<span class="op">&amp;&amp;</span> snd<span class="op">)</span>;</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span><span class="op">:</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">(</span>rw_serializer<span class="op">*</span> parent<span class="op">)</span>;</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    reader<span class="op">&amp;</span> get_reader<span class="op">()</span>;</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    writer<span class="op">&amp;</span> get_writer<span class="op">()</span>;</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <em>on-empty-sender</em> on_empty<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    in_place_stop_source<span class="op">&amp;</span> get_stop_source<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    in_place_stop_token get_stop_token<span class="op">()</span> <span class="kw">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> request_stop<span class="op">()</span> <span class="kw">noexcept</span>;</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h1 data-number="6" id="design-considerations"><span class="header-section-number">6</span> Design considerations<a href="#design-considerations" class="self-link"></a></h1>
<h2 data-number="6.1" id="a-new-abstraction"><span class="header-section-number">6.1</span> A new abstraction<a href="#a-new-abstraction" class="self-link"></a></h2>
<p><em>Note:</em> this section talks about the simple serializer, i.e.,
<code class="sourceCode default">serializer</code> class, but the
argument extends to other serializer abstractions defined here.</p>
<p>After agreeing that serializers are useful, one question that arise
is whether we need a separate abstraction (i.e., class) for a
serializer, or we can just use existing facilities.</p>
<p>One idea was to use <span class="citation" data-cites="P2300R5">[<a href="#ref-P2300R5" role="doc-biblioref">P2300R5</a>]</span> algorithms
to simulate a serializer behaviour, maybe in conjunction with some
helper class. In particular, the idea of using the
<code class="sourceCode default">on()</code> algorithm with a custom
scheduler was considered. However, there are two problems with this
approach:</p>
<ol type="1">
<li>we can control only the starting point of a computation, and not
necessarily the exit point</li>
<li>conceptually, schedulers work if we want the work to be executed
within a given context; we might want to use with serializers
computations that involve using multiple execution contexts</li>
</ol>
<p>Let’s assume that we want to pass through a (simple) serializer a
complex computation that does work across multiple execution contexts.
The idea of the serializer is to ensure that no other computation is
started in the serializer before the first computation is completed.
And, as this computation involves going through multiple execution
contexts, we cannot simply detect the termination point. Thus, point 1
above prevents use to use <code class="sourceCode default">on()</code>
and schedulers to implement serializers.</p>
<p>Furthermore, looking from the perspective of the second point, if the
computation is defined in terms of multiple schedulers, it is
conceptually wrong to model the serializer as a scheduler. One cannot
have a scheduler to execute work that needs to be executed on a series
of other schedulers.</p>
<p>Another idea that was considered is to use <span class="citation" data-cites="libunifex">[<a href="#ref-libunifex" role="doc-biblioref">libunifex</a>]</span>’s
<code class="sourceCode default">async_mutex</code> abstraction. This
can be used to model a simple serializer. The problem with this approach
is that it requires the user to manually <em>lock</em> and
<em>unlock</em> the mutex. This is considered unstructured and
error-prone to be generally used. However, it is worth noting that a
simple serializer can be implemented in terms of
<code class="sourceCode default">async_mutex</code>.</p>
<h2 data-number="6.2" id="interface-similar-to-async_scope"><span class="header-section-number">6.2</span> Interface similar to
<code class="sourceCode default">async_scope</code><a href="#interface-similar-to-async_scope" class="self-link"></a></h2>
<p><em>Note:</em> this section talks about the simple serializer, i.e.,
<code class="sourceCode default">serializer</code> class, but the
argument extends to other serializer abstractions defined here.</p>
<p>Designing the interface of a simple serializer can take several
directions. We chose to follow the interface of
<code class="sourceCode default">async_scope</code> (<span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span>) for two
reasons:</p>
<ul>
<li>it provides the functionality that we need</li>
<li>consistency</li>
</ul>
<p>In terms of needed functionality, we need the following:</p>
<ul>
<li>a method of adding work to the serializer
<ul>
<li>this can be obtained with
<code class="sourceCode default">spawn()</code>,
<code class="sourceCode default">spawn_future()</code> and
<code class="sourceCode default">nest()</code></li>
</ul></li>
<li>a method of querying the serializer whether it has work:
<code class="sourceCode default">on_empty()</code></li>
<li>allow cancellation</li>
</ul>
<p>Once we have <code class="sourceCode default">spawn()</code> as a way
to add work to the serializer, one might wonder why do we need
<code class="sourceCode default">spawn_future()</code> and
<code class="sourceCode default">nest()</code>. We follow the same
rationale as <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span> because the
needs of enqueuing work are similar.</p>
<p>Similar to <code class="sourceCode default">async_scope</code> we
need to be able to detect whenever the serializer doesn’t have work
enqueued anymore. One reason for this is that we cannot destruct the
serializer object while there is still work within it.</p>
<p>And, the same way that
<code class="sourceCode default">asynsc_scope</code> requires
cancellation, we require cancellation support for serializers, for the
same reasons.</p>
<p>Please note that, one important point of considering
<code class="sourceCode default">async_scope</code> as the starting
point for the serializers work is the fact that they provide a
structured way to work with dynamic computations. See more discussion of
about this aspect in <span class="citation" data-cites="D2519R0">[<a href="#ref-D2519R0" role="doc-biblioref"><strong>D2519R0?</strong></a>]</span>.</p>
<p>See also <a href="#comparison-with-async_scope">Comparison with
<code class="sourceCode default">async_scope</code></a></p>
<h2 data-number="6.3" id="including-n_serializer-and-rw_serializer"><span class="header-section-number">6.3</span> Including
<code class="sourceCode default">n_serializer</code> and
<code class="sourceCode default">rw_serializer</code><a href="#including-n_serializer-and-rw_serializer" class="self-link"></a></h2>
<p>One might want to separate into separate papers the 3 abstractions
proposed here: <code class="sourceCode default">serializer</code>,
<code class="sourceCode default">n_serializer</code> and
<code class="sourceCode default">rw_serializer</code>. While there are
reasons to do that (incremental progress works well with C++ standard
committee), there are also reasons to consider all 3 abstractions into
the same proposal.</p>
<p>First, these abstractions correspond to the main ways of
synchronization in the classical threading world; treating them together
seems to make sense. They provide tools to solve one type of
problem.</p>
<p>While there are differences between them, the commonalities seem more
important.</p>
<p>If we look at <code class="sourceCode default">serializer</code> and
<code class="sourceCode default">n_serializer</code> we realise that
they are extremely close. Actually, a
<code class="sourceCode default">serializer</code> object behaves the
same as an <code class="sourceCode default">n_serializer</code> object
constructed with a count of <code class="sourceCode default">1</code>.
Thus, <code class="sourceCode default">serializer</code> is a special
case of <code class="sourceCode default">n_serializer</code>.</p>
<p>Furthermore, an <code class="sourceCode default">rw_serializer</code>
can be thought of as a generalisation of a simple
<code class="sourceCode default">serializer</code> (all computations
given to it are <em>write</em> computations). But, in this case, the
interfaces of the two classes need to be different. This is because
<code class="sourceCode default">rw_serializer</code> can accept two
types of computations.</p>
<p>Keeping the two abstractions in the same paper allows us to consider
the enqueueing of dynamic computations with constraints in a more
general form.</p>
<h2 data-number="6.4" id="number-of-resources-protected-by-an-n_serializer-is-given-to-the-constructor"><span class="header-section-number">6.4</span> Number of resources protected
by an <code class="sourceCode default">n_serializer</code> is given to
the constructor<a href="#number-of-resources-protected-by-an-n_serializer-is-given-to-the-constructor" class="self-link"></a></h2>
<h2 data-number="6.5" id="rw_serializer-with-two-sub-objects"><span class="header-section-number">6.5</span>
<code class="sourceCode default">rw_serializer</code> with two
sub-objects<a href="#rw_serializer-with-two-sub-objects" class="self-link"></a></h2>
<h2 data-number="6.6" id="concepts-vs.-concrete-classes"><span class="header-section-number">6.6</span> Concepts vs. concrete classes<a href="#concepts-vs.-concrete-classes" class="self-link"></a></h2>
<h2 data-number="6.7" id="nest-as-a-basis-for-spawn-and-spawn_future"><span class="header-section-number">6.7</span>
<code class="sourceCode default">nest</code> as a basis for
<code class="sourceCode default">spawn</code> and
<code class="sourceCode default">spawn_future</code><a href="#nest-as-a-basis-for-spawn-and-spawn_future" class="self-link"></a></h2>
<h2 data-number="6.8" id="use-of-cpos"><span class="header-section-number">6.8</span> Use of CPOs<a href="#use-of-cpos" class="self-link"></a></h2>
<h1 data-number="7" id="comparison-with-other-models"><span class="header-section-number">7</span> Comparison with other models<a href="#comparison-with-other-models" class="self-link"></a></h1>
<h2 data-number="7.1" id="comparison-with-mutexes"><span class="header-section-number">7.1</span> Comparison with mutexes<a href="#comparison-with-mutexes" class="self-link"></a></h2>
<h2 data-number="7.2" id="comparison-with-p2300-model"><span class="header-section-number">7.2</span> Comparison with P2300 model<a href="#comparison-with-p2300-model" class="self-link"></a></h2>
<h2 data-number="7.3" id="comparison-with-async_scope"><span class="header-section-number">7.3</span> Comparison with
<code class="sourceCode default">async_scope</code><a href="#comparison-with-async_scope" class="self-link"></a></h2>
<h2 data-number="7.4" id="comparison-with-libunifexs-async_mutex"><span class="header-section-number">7.4</span> Comparison with libunifex’s
<code class="sourceCode default">async_mutex</code><a href="#comparison-with-libunifexs-async_mutex" class="self-link"></a></h2>
<h1 data-number="8" id="specification"><span class="header-section-number">8</span> Specification<a href="#specification" class="self-link"></a></h1>
<h1 data-number="9" id="bibliography"><span class="header-section-number">9</span> References<a href="#bibliography" class="self-link"></a></h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-codesearch" class="csl-entry" role="doc-biblioentry">
[codesearch] Andrew Tomazos. Code search engine website. <a href="https://codesearch.isocpp.org"><div class="csl-block">https://codesearch.isocpp.org</div></a>
</div>
<div id="ref-Dijkstra65" class="csl-entry" role="doc-biblioentry">
[Dijkstra65] E. W. Dijkstra. 1965. <em>Solution of a problem in
concurrent programming control</em>. Communications of the ACM,
September 1965.
</div>
<div id="ref-libunifex" class="csl-entry" role="doc-biblioentry">
[libunifex] Facebook. libunifex: Unified Executors. <a href="https://github.com/facebookexperimental/libunifex"><div class="csl-block">https://github.com/facebookexperimental/libunifex</div></a>
</div>
<div id="ref-P2300R5" class="csl-entry" role="doc-biblioentry">
[P2300R5] Michał Dominiak, Georgy Evtushenko, Lewis Baker, Lucian Radu
Teodorescu, Lee Howes, Kirk Shoop, Michael Garland, Eric Niebler, Bryce
Adelstein Lelbach. 2022-04-22. `std::execution`. <a href="https://wg21.link/p2300r5"><div class="csl-block">https://wg21.link/p2300r5</div></a>
</div>
</div>
</div>
</div>
</body>
</html>
